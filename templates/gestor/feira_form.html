{% extends 'gestor/base_gestor.html' %}
{% load static %}

{% block title %}{{ title }} | Portal de Eventos{% endblock %}

{% block content %}
<div class="card shadow">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">
      <i class="fas fa-calendar-alt me-2"></i> {{ title }}
    </h5>
    <a href="{% url 'gestor:feira_list' %}" class="btn btn-outline-secondary btn-sm">
      <i class="fas fa-arrow-left me-1"></i> Voltar
    </a>
  </div>

  <div class="card-body">
    <form method="post">
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {% for error in form.non_field_errors %}
            <p class="mb-0"><i class="fas fa-exclamation-circle me-2"></i>{{ error }}</p>
          {% endfor %}
        </div>
      {% endif %}

      <div class="row g-4">
        <!-- INFORMAÇÕES BÁSICAS - 2 COLUNAS -->
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-light">
              <h6 class="card-title mb-0">
                <i class="fas fa-info-circle me-2"></i>Informações Básicas
              </h6>
            </div>
            <div class="card-body">
              <!-- LINHA 1: NOME E STATUS -->
              <div class="row">
                <div class="col-md-6">
                  <!-- NOME -->
                  <div class="mb-3">
                    <label for="{{ form.nome.id_for_label }}" class="form-label fw-semibold">
                      Nome da Feira *
                    </label>
                    {{ form.nome }}
                    {% if form.nome.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.nome.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <div class="col-md-6">
                  <!-- STATUS -->
                  <div class="mb-3">
                    <label for="{{ form.status.id_for_label }}" class="form-label fw-semibold">
                      Status *
                    </label>
                    {{ form.status }}
                    {% if form.status.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.status.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- LINHA 2: LOCAL E PERÍODO -->
              <div class="row">
                <div class="col-md-6">
                  <!-- LOCAL -->
                  <div class="mb-3">
                    <label for="{{ form.local.id_for_label }}" class="form-label fw-semibold">
                      Local
                    </label>
                    {{ form.local }}
                    {% if form.local.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.local.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <div class="col-md-6">
                  <!-- PERÍODO -->
                  <div class="mb-3">
                    <label for="{{ form.periodo.id_for_label }}" class="form-label fw-semibold">
                      Período
                    </label>
                    {{ form.periodo }}
                    {% if form.periodo.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.periodo.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- LINHA 3: PÚBLICO ALVO E DIFERENCIAL -->
              <div class="row">
                <div class="col-md-6">
                  <!-- PÚBLICO ALVO -->
                  <div class="mb-3">
                    <label for="{{ form.publico_alvo.id_for_label }}" class="form-label fw-semibold">
                      Público Alvo
                    </label>
                    {{ form.publico_alvo }}
                    {% if form.publico_alvo.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.publico_alvo.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <div class="col-md-6">
                  <!-- DIFERENCIAL -->
                  <div class="mb-3">
                    <label for="{{ form.diferencial.id_for_label }}" class="form-label fw-semibold">
                      Diferencial
                    </label>
                    {{ form.diferencial }}
                    {% if form.diferencial.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.diferencial.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- CREDENCIAMENTO -->
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-light">
              <h6 class="card-title mb-0">
                <i class="fas fa-id-card me-2"></i>Credenciamento
              </h6>
            </div>
            <div class="card-body">
              <!-- CREDENCIAMENTO TEXTO -->
              <div class="row">
                <div class="col-12">
                  <div class="mb-3">
                    <label for="{{ form.credenciamento.id_for_label }}" class="form-label fw-semibold">
                      Credenciamento
                    </label>
                    {{ form.credenciamento }}
                    {% if form.credenciamento.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.credenciamento.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- CREDENCIAMENTO CATEGORIAS (JSON) -->
              <div class="row">
                <div class="col-12">
                  <div class="mb-3">
                    <label class="form-label fw-semibold">
                      Categorias de Credenciamento
                    </label>

                    <!-- Campo hidden para armazenar o JSON -->
                    <textarea id="id_credenciamento_categorias" name="credenciamento_categorias" style="display: none;"></textarea>

                    <!-- Script para passar dados Python -> JSON válido -->
                    {{ form.instance.credenciamento_categorias|json_script:"credenciamento-data" }}

                    <!-- Container das categorias -->
                    <div id="categorias-container" class="mb-3">
                      <!-- As categorias serão inseridas aqui via JavaScript -->
                    </div>

                    <!-- Botão adicionar categoria -->
                    <button type="button" class="btn btn-outline-primary btn-sm" id="btn-add-categoria">
                      <i class="fas fa-plus me-1"></i> Adicionar Categoria
                    </button>

                    {% if form.credenciamento_categorias.errors %}
                      <div class="text-danger small mt-2">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.credenciamento_categorias.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- INGRESSOS - 2 COLUNAS -->
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-light">
              <h6 class="card-title mb-0">
                <i class="fas fa-receipt me-2"></i>Ingressos
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <!-- INGRESSO EXPERIENCE -->
                  <div class="mb-3">
                    <label for="{{ form.ingresso_experience.id_for_label }}" class="form-label fw-semibold">
                      Ingresso Experience
                    </label>
                    {{ form.ingresso_experience }}
                    {% if form.ingresso_experience.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.ingresso_experience.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <div class="col-md-6">
                  <!-- INGRESSO BLACK -->
                  <div class="mb-3">
                    <label for="{{ form.ingresso_black.id_for_label }}" class="form-label fw-semibold">
                      Ingresso Black
                    </label>
                    {{ form.ingresso_black }}
                    {% if form.ingresso_black.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.ingresso_black.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- DESCONTOS E CUPONS -->
              <hr class="my-4">
              <h6 class="mb-3"><i class="fas fa-tags me-2"></i>Descontos e Cupons</h6>

              <div class="row">
                <div class="col-md-6">
                  <!-- DESCONTO NÍVEL 1 -->
                  <div class="mb-3">
                    <label for="{{ form.desconto_nivel_1.id_for_label }}" class="form-label fw-semibold">
                      Desconto Nível 1
                    </label>
                    {{ form.desconto_nivel_1 }}
                    {% if form.desconto_nivel_1.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.desconto_nivel_1.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <div class="col-md-6">
                  <!-- DESCONTO NÍVEL 2 -->
                  <div class="mb-3">
                    <label for="{{ form.desconto_nivel_2.id_for_label }}" class="form-label fw-semibold">
                      Desconto Nível 2
                    </label>
                    {{ form.desconto_nivel_2 }}
                    {% if form.desconto_nivel_2.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.desconto_nivel_2.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <!-- DESCONTO CUPOM 1 -->
                  <div class="mb-3">
                    <label for="{{ form.desconto_cupom_1.id_for_label }}" class="form-label fw-semibold">
                      Desconto Cupom 1
                    </label>
                    {{ form.desconto_cupom_1 }}
                    {% if form.desconto_cupom_1.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.desconto_cupom_1.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <div class="col-md-6">
                  <!-- DESCONTO CUPOM 2 -->
                  <div class="mb-3">
                    <label for="{{ form.desconto_cupom_2.id_for_label }}" class="form-label fw-semibold">
                      Desconto Cupom 2
                    </label>
                    {{ form.desconto_cupom_2 }}
                    {% if form.desconto_cupom_2.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.desconto_cupom_2.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- LINKS - 2 COLUNAS -->
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-light">
              <h6 class="card-title mb-0">
                <i class="fas fa-link me-2"></i>Links
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <!-- LINK EXPOSITORES -->
                  <div class="mb-3">
                    <label for="{{ form.link_expositores.id_for_label }}" class="form-label fw-semibold">
                      Link Expositores
                    </label>
                    {{ form.link_expositores }}
                    {% if form.link_expositores.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.link_expositores.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <div class="col-md-6">
                  <!-- LINK EMBAIXADORES -->
                  <div class="mb-3">
                    <label for="{{ form.link_embaixadores.id_for_label }}" class="form-label fw-semibold">
                      Link Embaixadores
                    </label>
                    {{ form.link_embaixadores }}
                    {% if form.link_embaixadores.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.link_embaixadores.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- DETALHES COMPLETOS -->
        <div class="col-12">
          <div class="card">
            <div class="card-header bg-light">
              <h6 class="card-title mb-0">
                <i class="fas fa-file-alt me-2"></i>Detalhes e Observações
              </h6>
            </div>
            <div class="card-body">
              <!-- LINHA 1: INFRAESTRUTURA E OPORTUNIDADES -->
              <div class="row">
                <div class="col-md-6">
                  <!-- INFRAESTRUTURA -->
                  <div class="mb-3">
                    <label for="{{ form.Infraestrutura_e_servicos.id_for_label }}" class="form-label fw-semibold">
                      Infraestrutura e Serviços
                    </label>
                    {{ form.Infraestrutura_e_servicos }}
                    {% if form.Infraestrutura_e_servicos.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.Infraestrutura_e_servicos.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <div class="col-md-6">
                  <!-- OPORTUNIDADES -->
                  <div class="mb-3">
                    <label for="{{ form.Oportunidades_de_negocio.id_for_label }}" class="form-label fw-semibold">
                      Oportunidades de Negócio
                    </label>
                    {{ form.Oportunidades_de_negocio }}
                    {% if form.Oportunidades_de_negocio.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.Oportunidades_de_negocio.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- LINHA 2: OBSERVAÇÕES E GATILHOS -->
              <div class="row">
                <div class="col-md-6">
                  <!-- OBSERVAÇÕES -->
                  <div class="mb-3">
                    <label for="{{ form.Observacoes.id_for_label }}" class="form-label fw-semibold">
                      Observações
                    </label>
                    {{ form.Observacoes }}
                    {% if form.Observacoes.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.Observacoes.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>

                <div class="col-md-6">
                  <!-- GATILHOS -->
                  <div class="mb-3">
                    <label for="{{ form.Gatilhos_de_urgencia.id_for_label }}" class="form-label fw-semibold">
                      Gatilhos de Urgência
                    </label>
                    {{ form.Gatilhos_de_urgencia }}
                    {% if form.Gatilhos_de_urgencia.errors %}
                      <div class="text-danger small mt-1">
                        <i class="fas fa-exclamation-triangle me-1"></i>{{ form.Gatilhos_de_urgencia.errors.0 }}
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- BOTÕES -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="d-flex justify-content-end gap-2">
            <a href="{% url 'gestor:feira_list' %}" class="btn btn-outline-secondary">
              <i class="fas fa-times me-1"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-1"></i>
              {% if form.instance.pk %}Atualizar{% else %}Criar{% endif %} Feira
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal para Editar Categoria -->
<div class="modal fade" id="modalCategoria" tabindex="-1" aria-labelledby="modalCategoriaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalCategoriaLabel">
          <i class="fas fa-box me-2"></i><span id="modal-title-text">Adicionar Categoria</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="categoria-index">

        <div class="mb-3">
          <label for="categoria-nome" class="form-label fw-semibold">Categoria *</label>
          <input type="text" class="form-control" id="categoria-nome" placeholder="Ex: Público Geral (Vendas até 17/11/2025)" required>
        </div>

        <div class="mb-3">
          <label for="categoria-status" class="form-label fw-semibold">Status *</label>
          <select class="form-select" id="categoria-status" required>
            <option value="">--- Selecione ---</option>
            <option value="disponivel">Disponível</option>
            <option value="em_breve">Em Breve</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="categoria-link" class="form-label fw-semibold">Link</label>
          <input type="url" class="form-control" id="categoria-link" placeholder="https://www.sympla.com.br/evento/...">
        </div>

        <div class="mb-3">
          <label for="categoria-observacao" class="form-label fw-semibold">Observação</label>
          <textarea class="form-control" id="categoria-observacao" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i> Cancelar
        </button>
        <button type="button" class="btn btn-primary" id="btn-save-categoria">
          <i class="fas fa-save me-1"></i> Salvar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let categorias = [];
  let editingIndex = null;
  const modal = new bootstrap.Modal(document.getElementById('modalCategoria'));

  // Escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Carregar categorias existentes
  function loadCategorias() {
    // Tentar carregar do script tag JSON gerado pelo Django
    const scriptTag = document.getElementById('credenciamento-data');

    if (scriptTag) {
      try {
        const data = JSON.parse(scriptTag.textContent);
        if (Array.isArray(data) && data.length > 0) {
          categorias = data;
          // Atualizar o textarea hidden
          document.getElementById('id_credenciamento_categorias').value = JSON.stringify(categorias);
        }
      } catch (e) {
        console.error('Erro ao carregar categorias:', e);
      }
    }

    // Fallback: tentar carregar do textarea
    if (categorias.length === 0) {
      const textarea = document.getElementById('id_credenciamento_categorias');
      const jsonValue = textarea.value;

      if (jsonValue && jsonValue.trim() !== '') {
        try {
          categorias = JSON.parse(jsonValue);
        } catch (e) {
          console.error('Erro ao fazer parse do textarea:', e);
          categorias = [];
        }
      }
    }

    renderCategorias();
  }

  // Renderizar categorias
  function renderCategorias() {
    const container = document.getElementById('categorias-container');

    if (!container) {
      console.error('Container categorias-container não encontrado!');
      return;
    }

    container.innerHTML = '';

    if (categorias.length === 0) {
      container.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>Nenhuma categoria adicionada ainda.</div>';
      return;
    }

    categorias.forEach((cat, index) => {
      // Normalizar status (pode vir como 'disponivel', 'Disponível', 'em_breve', etc)
      const statusNormalizado = (cat.status || '').toLowerCase().replace(/\s+/g, '_');
      let statusBadge;

      if (statusNormalizado === 'disponivel' || statusNormalizado === 'disponível') {
        statusBadge = '<span class="badge bg-success">Disponível</span>';
      } else if (statusNormalizado === 'em_breve') {
        statusBadge = '<span class="badge bg-warning text-dark">Em Breve</span>';
      } else {
        // Fallback para valores desconhecidos
        statusBadge = '<span class="badge bg-secondary">' + escapeHtml(cat.status || 'N/A') + '</span>';
      }

      const card = `
        <div class="card mb-2">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6 class="mb-2">
                  <i class="fas fa-box me-2"></i>${escapeHtml(cat.categoria || 'Sem nome')}
                  ${statusBadge}
                </h6>
                ${cat.observacao ? `<p class="mb-0 small text-muted"><i class="fas fa-comment me-2"></i>${escapeHtml(cat.observacao)}</p>` : ''}
              </div>
              <div class="btn-group btn-group-sm ms-3">
                <button type="button" class="btn btn-outline-primary" onclick="editCategoria(${index})">
                  <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="deleteCategoria(${index})">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      container.innerHTML += card;
    });

    // Atualizar campo hidden
    document.getElementById('id_credenciamento_categorias').value = JSON.stringify(categorias);
  }

  // Adicionar categoria
  document.getElementById('btn-add-categoria').addEventListener('click', function() {
    editingIndex = null;
    document.getElementById('modal-title-text').textContent = 'Adicionar Categoria';
    document.getElementById('categoria-index').value = '';
    document.getElementById('categoria-nome').value = '';
    document.getElementById('categoria-status').value = '';
    document.getElementById('categoria-link').value = '';
    document.getElementById('categoria-observacao').value = '';
    modal.show();
  });

  // Editar categoria (função global)
  window.editCategoria = function(index) {
    editingIndex = index;
    const cat = categorias[index];
    document.getElementById('modal-title-text').textContent = 'Editar Categoria';
    document.getElementById('categoria-index').value = index;
    document.getElementById('categoria-nome').value = cat.categoria || '';
    document.getElementById('categoria-status').value = cat.status || '';
    document.getElementById('categoria-link').value = cat.link || '';
    document.getElementById('categoria-observacao').value = cat.observacao || '';
    modal.show();
  };

  // Deletar categoria (função global)
  window.deleteCategoria = function(index) {
    if (confirm('Tem certeza que deseja remover esta categoria?')) {
      categorias.splice(index, 1);
      renderCategorias();
    }
  };

  // Salvar categoria
  document.getElementById('btn-save-categoria').addEventListener('click', function() {
    const nome = document.getElementById('categoria-nome').value.trim();
    const status = document.getElementById('categoria-status').value;
    const link = document.getElementById('categoria-link').value.trim();
    const observacao = document.getElementById('categoria-observacao').value.trim();

    if (!nome) {
      alert('Por favor, preencha o nome da categoria.');
      return;
    }

    if (!status) {
      alert('Por favor, selecione o status.');
      return;
    }

    const categoria = {
      categoria: nome,
      status: status,
      link: link,
      observacao: observacao
    };

    if (editingIndex !== null) {
      // Editando
      categorias[editingIndex] = categoria;
    } else {
      // Adicionando
      categorias.push(categoria);
    }

    renderCategorias();
    modal.hide();
  });

  // Inicializar
  loadCategorias();
});
</script>
{% endblock %}
